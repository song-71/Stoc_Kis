# ws_realtime_subscribe_to_parquet-2.py 전체 점검 분석 보고서

## 1. 구독 종목 16개 고정 문제

**현황**: TOP_RANK_ADD_N=5, Top50에서 5개 추가 설계인데 16개로 고정됨

**원인 분석**:
- `_base_codes` = CODE_TEXT 16개 (보호 대상)
- 추가 조건: `code not in _base_codes` and `code not in codes` and `_is_stock_group(code)`
- `_is_stock_group()` = KRX_code.csv의 group == "ST" 만 통과
- **KRX_code.csv 없거나 캐시 미로드 시** `return True` (통과)
- 가능 원인: (1) Top50 상위가 대부분 우리 16개와 겹침 (2) KRX group 필터로 ST 아닌 종목 제외 (3) schedule 타이밍 - 9:00 첫 fetch 시 API 실패/지연

**조치**: KRX 캐시 로드 실패 시 로그 명확화, "구독 추가 없음" 시 사유 로깅 추가, Top150 옵션 검토

---

## 2. 20초 미수신 지속 vs 15:10 watchdog 즉시 해제 (불일치)

**현황**: 유투바이오·셀레믹스는 20초 미수신으로 계속 표시되나 해제 안 함. 15:10에는 전환 직후 8개 "3분 미수신"으로 즉시 해제

**원인**:
- 20초 미수신: `_log_stale_after_save()` → 로그만 (텔레그램 제거됨)
- watchdog 3분: `_code_added_ts` 기준. **종가매매 전환 시 `_code_added_ts` 미갱신** → 수정 완료
- 20초 미수신은 "감지"만 하고 **구독 해제는 하지 않음** (설계상). watchdog은 "WSS 한 번도 미수신 + 추가 시점 3분 경과" 시에만 해제
- 유투바이오·셀레믹스: 가끔 수신되면 `_last_recv_ts` 갱신 → 3분 경과 안 됨. 20초는 넘지만 3분은 안 넘어서 해제 안 됨

**결론**: 20초=감지/모니터링, 3분=실제 해제. 설계는 일관됨. (이미 _code_added_ts 수정으로 15:10 오동작은 해결)

---

## 3. 중복 컬럼 경고 (duplicate cols removed)

**원인**: WSS/API가 동일 필드를 다른 casing으로 반환 (예: stck_prpr, Stck_prpr). `_norm_cols()`로 소문자 통일 시 중복 발생

**현재 처리**: `df2.loc[:, ~df2.columns.duplicated()]` → **첫 번째 컬럼만 유지**, 나머지 drop. 둘째에 값이 있으면 **데이터 손실**

**조치**: 중복 시 **머지** (첫 non-null 값 채우기) 적용. 또는 API 응답 원본에서 컬럼 생성 시 소문자 통일 + dedup

---

## 4. 15:09 vs 15:10 Top50 중복 다운로드

**현황**: 15:09에 Top50 다운로드 후 15:10에 또 다운로드

**원인**: `_build_top_rank_schedule`에 15:09, 15:10 둘 다 포함. 매 슬롯마다 fetch 실행. 15:10은 구독 전환만 하면 되는데 fetch까지 수행

**조치**: `is_closing_switch` 시 **fetch 스킵**, `_closing_codes` 그대로 사용

---

## 5. 15:10:01 다중 save (7, 28, 11, 1, 15... rows)

**원인**: `_switch_to_closing_codes()`에서 기존 16개 각각에 대해 `_flush_code(c, force=True)` 호출. 종목별로 버퍼 flush → "=> [save] N rows" 16회 출력

**결론**: 설계상 정상 동작. 전환 시 기존 버퍼를 종목별로 비우는 과정.

---

## 6. 아크릴·유투바이오 - 20초 미수신인데 종가매매 10개에 포함

**설명**: 
- **20초 미수신**: WSS 실시간 스트림 미수신
- **종가매매 선정**: REST `_fetch_fluctuation_top` (상승률 Top50) 기준
- 서로 다른 경로. REST로 상승률 조회 시 해당 종목이 상위에 포함되어 선정됨. WSS 수신 여부와 무관

---

## 7. 15:30 체결가 - 중복 경고 + 컬럼 리스트 다름

**원인**: 예상체결가(regular_exp) → 실시간체결가(regular_real) 전환. TR별 스키마 차이. 실시간체결가가 컬럼 수 많음. 대소문자 혼재로 중복 발생

**조치**: 동일 (3번) - 중복 컬럼 머지 적용

---

## 8. 15:31 이후에도 "60초 미수신 → 재구독" 반복

**원인**: `scheduler_loop`에서 `idle_sec >= NO_DATA_REBUILD_SEC` 시 무조건 `_apply_subscriptions(..., force=True)` 호출. 15:31~16:00에는 `_desired_subscription_map()`이 `{}` 반환하지만, **재구독 시도 로직 자체는 계속 실행**. desired가 비어 있어도 15초마다 "재구독" 메시지 출력

**조치**: 15:31~16:00 구간(`CLOSE_STOP_TIME` 이후, 16:00 전)에서는 **재구독 시도 생략**

---

## 9. 16:00 전환 - 2종목만, "핑퐁만 수신 가능" 메시지

**2종목만**: 15:10 watchdog 오동작으로 8개 해제 → 아크릴·유투바이오 2개만 남음 (이미 _code_added_ts 수정으로 해결 예정)

**"핑퐁만 수신 가능"**: 현재 코드에는 해당 문구 없음. 예전 버전 또는 다른 모듈에서 출력된 것으로 추정. 해당 표현이 있다면 **추측성 메시지**이므로 제거 필요. 실제 핑퐁 구현 여부에 따라만 출력

---

## 10. 토큰 오류 (bash: syntax error near unexpected token `초당`)

**원인**: 제자리 갱신용 `\r` + "(초당 수신건수...)" 포함된 로그가 `2>&1`로 리다이렉트되며, 터미널/파이프에서 괄호 등이 bash에 전달되어 파싱 오류 발생 가능

**조치**: 로그/출력 포맷 검토. 위험한 특수문자 이스케이프 또는 출력 포맷 단순화

---

## 수정 우선순위

| # | 항목 | 심각도 | 수정 |
|---|------|--------|------|
| 1 | 15:10 _code_added_ts | 높음 | 완료 |
| 2 | 15:31 이후 재구독 시도 차단 | 높음 | 진행 |
| 3 | 15:10 fetch 스킵 | 중간 | 진행 |
| 4 | 중복 컬럼 머지 (첫 non-null) | 중간 | 진행 |
| 5 | "핑퐁" 등 추측 메시지 제거 | 낮음 | 코드 검색 후 삭제 |
| 6 | Top 추가 실패 시 사유 로깅 | 낮음 | 진행 |
