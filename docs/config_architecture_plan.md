# config.json 구조 및 아키텍처 계획

> 나중에 실행 시 참고용. 추가 정리 후 사용 예정.

---
1. 목표 구조 요약
항목	내용
코드베이스	DB-1 한 파일로 통합 (같은 전략 로직)
실행 방식	여러 사용자/계좌에 동시 적용
개인화	자본금, 최대투자한도, 권한 등 사용자별 설정
격리	주문/모니터링은 계정·계좌별로 완전 분리

## 1. 결론 요약

| 항목 | 선택 |
|------|------|
| config 구조 | **방안 A: users 중심** |
| 실행 아키텍처 | **A안: 단일 프로세스, 계좌 순회** |
| 코드베이스 | DB-1 한 파일로 충분 |

---

## 2. config 구조 (방안 A: users 중심)

### 2-1. 예시 스키마

```json
{
  "default_user": "sywems12",
  "global": {
    "base_url": "https://openapi.koreainvestment.com:9443",
    "exclude_cash": "14000000",
    "checkpoints": {},
    "wss_subscribe_codes": [],
    "print_option": ""
  },

  "users": {
    "sywems12": {
      "htsid": "sywems12",
      "BOT_TOKEN": "8282014572:...",
      "CHAT_ID": "5901426769",
      "capital": 1000000,
      "max_invest_per_stock": 100000,
      "max_total_invest": 500000,
      "enabled": true,
      "accounts": {
        "main": {
          "appkey": "PSqbw6L...",
          "appsecret": "RaKAYqg...",
          "cano": "43444822",
          "acnt_prdt_cd": "01"
        },
        "syw_2": {
          "appkey": "PS9hPVW...",
          "appsecret": "X/l3Fxd...",
          "cano": "63614390",
          "acnt_prdt_cd": "01"
        }
      }
    }
  }
}
```

### 2-2. 사용자(users) 단위 설정

| 필드 | 용도 |
|------|------|
| `htsid` | HTS 로그인 ID (WebSocket 체결통보용) |
| `BOT_TOKEN`, `CHAT_ID` | 텔레그램 알림 |
| `capital` | 사용자 자본금 (종목 수·매수 금액 계산 기준) |
| `max_invest_per_stock` | 종목별 최대 투자액 |
| `max_total_invest` | 최대 총 투자 한도 |
| `enabled` | 활성화 여부 |

### 2-3. 계좌(accounts) 단위 설정

| 필드 | 용도 |
|------|------|
| `appkey`, `appsecret` | API 인증 |
| `cano`, `acnt_prdt_cd` | 계좌 식별 |

---

## 3. 아키텍처 (단일 프로세스, 계좌 순회)

### 3-1. 공통 vs 개별

| 구분 | 공통 | 개별 |
|------|------|------|
| **트리거 (매매 신호)** | 동일 시세·동일 로직 | - |
| **주문 실행** | 같은 알고리즘 | 계좌별 잔고·한도·권한에 따라 상이 |
| **모니터링 로직** | 동일 | 계좌·종목별 state 분리 |

- **트리거**: buy/sell 등 시그널은 공동 사용
- **주문**: 실제 주문은 각 계정별 계좌 잔고, 한도 등에 따라 차등 적용
- **모니터링**: 로직은 동일, 계좌·종목별 관리만 각각 수행

### 3-2. 실행 흐름

```
[시세 WebSocket 1개]
        │
        ▼
   트리거 계산 (공통)
   예: 15:19 매수 신호 발생
        │
        ├─────────────────────────────────────
        │
        ▼
   for account in enabled_accounts:
       ├─ 잔고 조회 (계좌별)
       ├─ 한도·권한 체크 (사용자별)
       ├─ 주문 실행 (계좌별 appkey)
       └─ 체결/모니터링 (계좌별 state)
```

---

## 4. DB-1, DB-2 관련 (참고)

- **DB-1, DB-2**: 정해진 종목 웹수신 vs 수시 변동 웹수신, 에러 시 백업 데이터 확보용으로 사용
- **실제 운용**: 앞으로는 DB-1만으로 충분
- **두 개로 나눠 본 이유**: 한 계정 용량 초과 시 다른 계정으로 전환 가능함을 확인
- **향후**: DB-1 로직을 다른 사람 계정이 추가되어도 동시에 적용
  - 사용자별 자본금 → 종목 수 또는 종목별 금액 차등
  - 개인별 권한 → 최대 투자 한도 등 설정
  - 주문·모니터링은 계정별·계좌별로 별도 진행

---

## 5. 향후 작업 순서 (예정)

1. config 스키마를 users 중심으로 마이그레이션
2. `get_user_config()`, `get_account_config()` 헬퍼 함수 도입
3. DB-1 코드를 계좌 순회 루프로 전환

---

## 6. 변경 이력

| 날짜 | 내용 |
|------|------|
| 2026-02-18 | 최초 작성, 방안 A 결정 |
