# Str1 매도 로직 점검 리포트 (2026-02-27)

## 상황 요약

- **나무기술**: 13:13 시점 모니터링에서 `예상가=6,030` `전일대비=+1.34%` `매수가=5,950` → "이상없음"
- **실제**: 현재가 5,680원으로 매수가(5,950) 이하 하락
- **문제**: 매수대비 하락인데 매도조건으로 인식되지 않음

## ※ 데이터 확인 결과 (수정 반영)

- **나무기술(242040)**: wss_data parts에서 **H0STCNT0(실시간 체결)** 수신 확인, prdy_ctrt=-4.54, new_mkop_cls_code=20
- 장중 13:13에 "장전 예상체결가"는 잘못된 표기 → **수정**: 장중엔 "[Str1 포지션 모니터링]"
- regular_real 수신 시 _premarket_watch 미갱신으로 stale 표시 → **수정**: 정규장 틱마다 _premarket_watch 실시간 갱신

---

## 1. 매도 로직 구조

### 1-1. 시간대별 트리거

| 시간대 | 데이터 종류 | 매도조건 판단 |
|--------|-------------|---------------|
| **08:29~09:00** | `regular_exp` (예상체결) | `check_premarket_sell(antc, prdy)` → prdy_ctrt < 0 시 시초가 매도 |
| **09:00~15:20** | `regular_real` (실시간 체결) | ① 가중평균 하락 ② 데드크로스 ③ **전일종가 하락(prdy_ctrt < 0)** |
| **09:00~15:20** | 주기 체크 15초마다 | `_check_sell_by_prdy_ctrt_periodic()` → `_last_prdy_ctrt` 캐시로 prdy < 0 종목 즉시 매도 |

### 1-2. [장전 예상체결가 모니터링] 출력 조건

- **조건**: `kind == "regular_exp"` (예상체결가 스트림) 수신 시에만 동작
- **시간**: 08:29~09:00(장전), 15:20~15:30(장마감), **그리고 57/59(30분 단일가) 종목은 09:00~15:20에도 예상체결가 수신**

---

## 2. 원인 분석

### 2-1. 13:13에 "장전 예상체결가 모니터링"이 뜨는 이유

13:13에 `[장전 예상체결가 모니터링]`이 나온다면, **나무기술이 예상체결가(exp_ccnl_krx) 구독 대상**이라는 의미입니다.

정규장 09:00~15:20에 예상체결가를 받는 경우:

1. **57/59 (30분 단일가) 종목**  
   - 매 30분 단일가 매매  
   - XX:05~XX:29에는 `exp_ccnl_krx` 수신, XX:29:29~XX:00:05에는 `ccnl_krx` 수신  
   - 13:13 → `exp_ccnl_krx` 수신 구간

2. **VI 지연 종목 (09:00~09:02 한정)**  
   - 13:13에는 해당 없음

### 2-2. 나무기술이 57/59 종목인 경우

- **예상체결가(antc_prce)**: 다음 단일가(13:30) 체결 예상가
- 13:00~13:29 구간에는 실시간 체결이 없어 예상가가 **자주 갱신되지 않음**
- 화면에 보이는 예상가(6,030)는 13:30 단일가 기준이며, 5,680 같은 실시간 시세와는 다른 값일 수 있음
- → **57/59 종목이면 예상가 기준 모니터링으로는 “실제 하락”을 제때 포착하기 어려움**

### 2-3. 나무기술이 일반 종목인 경우

일반 종목이면 13:13에는 `ccnl_krx`(실시간 체결)만 수신하고, `[장전 예상체결가 모니터링]`은 나오지 않습니다.

그래서 **나무기술이 13:13에 “장전 모니터링”에 잡힌다면, 57/59 종목으로 간주하는 것이 맞습니다.**

---

## 3. 매도 로직 상세

### 3-1. 틱 기반 (_check_str1_sell_conditions)

```
regular_real 수신 시:
  - check_realtime_sell(bidp1, wghn, ma50, ma500, oprc)
  - 추가: prdy_ctrt < 0 → _enqueue_str1_sell("전일종가하락")
```

- `regular_real` 수신 시점에만 실행
- 57/59는 XX:29:29~XX:00:05 구간에만 `regular_real` 수신 → 그 외 구간에서는 이 로직 미동작

### 3-2. 주기 체크 (_check_sell_by_prdy_ctrt_periodic, 15초마다)

```
premarket_ordered=False, sold=False 종목:
  - _last_prdy_ctrt[code] < 0 → _enqueue_str1_sell("전일종가하락-주기체크")
```

- `_last_prdy_ctrt`는 **틱 수신 시**만 갱신됨 (ingest_loop 5103~5117줄)
- 57/59 종목은 XX:05~XX:29 구간에 `regular_exp`만 수신
- exp 스트림에도 `prdy_ctrt` 포함되므로, 해당 틱이 들어오면 `_last_prdy_ctrt`는 갱신됨  
  → 다만 57/59는 틱이 거의 없어 갱신 빈도가 낮을 수 있음

### 3-3. premarket_ordered=True인 경우 (중요)

- `_check_str1_sell_conditions`: `premarket_ordered and is_regular` → **continue (매도 판단 스킵)**
- `_check_sell_by_prdy_ctrt_periodic`: `premarket_ordered` → **대상에서 제외**
- 장전에 하락으로 매도 주문을 넣어 `premarket_ordered=True`가 된 종목은, **09:00 이후 틱/주기 체크 모두에서 매도 검사가 되지 않음**
- 이 경우 “09:00 시초가 체결 예정”으로만 처리되고, 이후 추가 매도 판단은 하지 않음

---

## 4. 결론 및 권장 조치

### 4-1. 나무기술이 57/59 (30분 단일가)인 경우

| 문제 | 설명 |
|------|------|
| 예상가 기준 판단 | 예상가는 다음 단일가 기준이라 실시간 가격과 괴리 가능 |
| 틱 부족 | XX:05~XX:29 구간에 체결 거의 없어 `_last_prdy_ctrt` 갱신이 드묾 |
| 매도 판단 경로 부족 | 이 구간에는 `regular_real` 미수신 → 틱 기반 전일종가 하락 로직 동작 안 함 |

**권장:**

1. 57/59 종목에 대해 **예상가 대신 REST 조회 가격**으로 보완
   - 예: 주기적으로 `inquire-price` 등 REST API로 현재가 조회 후 prdy_ctrt 계산
2. 또는 57/59 구간에는 **예상가가 매수가 이하일 때도 매도조건으로 간주**하도록 `check_premarket_sell`/정규장 로직 확장

### 4-2. premarket_ordered=True 여부 확인

- 장전에 하락으로 매도 주문을 넣었다가, 예상가 복귀로 취소하지 못한 경우 `premarket_ordered=True`가 남을 수 있음
- 이 상태면 **09:00 이후 전일종가 하락·주기체크 모두에서 제외됨**
- `closing_buy_state_{yymmdd}.json`의 `sell_state`에서 해당 종목의 `premarket_ordered` 값을 확인 필요

### 4-3. 나무기술 57/59 여부 확인

- `data/wss_data/parts` 또는 parquet의 `new_mkop_cls_code` (종목상태)
- 57: 30분 단일가, 59: 단기과열 30분 단일가
- 로그에 `[stale] 나무기술(??????) 30분 단위 단일가` 메시지가 있으면 57/59로 분류된 것

---

## 5. 코드 참고 위치

| 항목 | 파일 | 라인 |
|------|------|------|
| 장전 매도 조건 | kis_str1_realtime_sell.py | check_premarket_sell (prdy < 0) |
| 정규장 전일종가 하락 | ws_realtime_subscribe_to_DB-1.py | 4788~4795 |
| 주기 체크 (15초) | ws_realtime_subscribe_to_DB-1.py | 1463~1506, 2533~2538 |
| premarket_ordered 스킵 | ws_realtime_subscribe_to_DB-1.py | 4689~4691, 1489 |
| _last_prdy_ctrt 갱신 | ws_realtime_subscribe_to_DB-1.py | 5103~5117 |
| 57/59 구독 분리 | ws_realtime_subscribe_to_DB-1.py | 5350~5369, 2943 |
